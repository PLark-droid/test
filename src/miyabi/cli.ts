#!/usr/bin/env node
/**
 * Miyabi Framework - CLI Entry Point
 * ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
 *
 * Usage:
 *   npx miyabi run <issue-number>  - ç‰¹å®šã®Issueã‚’å‡¦ç†
 *   npx miyabi status              - ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
 *   npx miyabi list                - ã‚ªãƒ¼ãƒ—ãƒ³ãªIssueã‚’ä¸€è¦§
 */

import dotenv from 'dotenv';
import path from 'path';
import { CoordinatorAgent } from './agents/coordinatorAgent.js';
import { GitHubClient } from './github.js';
import { AgentContext } from './types.js';

// .envã‚’èª­ã¿è¾¼ã‚€
dotenv.config();

const LOGO = `
ğŸŒ¸ Miyabi Framework
   è‡ªå¾‹å‹é–‹ç™ºã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
`;

async function main() {
  console.log(LOGO);

  const args = process.argv.slice(2);
  const command = args[0];

  if (!command || command === 'help') {
    showHelp();
    return;
  }

  // ç’°å¢ƒå¤‰æ•°ã‚’ãƒã‚§ãƒƒã‚¯
  const githubToken = process.env.GITHUB_TOKEN;
  const anthropicApiKey = process.env.ANTHROPIC_API_KEY;
  const repository = process.env.REPOSITORY;

  if (!githubToken || githubToken === 'ghp_your_github_token_here') {
    console.error('âŒ GITHUB_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    console.error('   .env ãƒ•ã‚¡ã‚¤ãƒ«ã«æœ‰åŠ¹ãªGitHub tokenã‚’è¨­å®šã—ã¦ãã ã•ã„');
    process.exit(1);
  }

  if (!anthropicApiKey || anthropicApiKey === 'sk-ant-your_anthropic_key_here') {
    console.error('âŒ ANTHROPIC_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    console.error('   .env ãƒ•ã‚¡ã‚¤ãƒ«ã«æœ‰åŠ¹ãªAnthropic API keyã‚’è¨­å®šã—ã¦ãã ã•ã„');
    process.exit(1);
  }

  if (!repository) {
    console.error('âŒ REPOSITORY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    console.error('   .env ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒªãƒã‚¸ãƒˆãƒª (ä¾‹: owner/repo) ã‚’è¨­å®šã—ã¦ãã ã•ã„');
    process.exit(1);
  }

  const github = new GitHubClient(githubToken, repository);

  switch (command) {
    case 'run':
      await runIssue(args[1], github, anthropicApiKey, repository);
      break;

    case 'list':
      await listIssues(github);
      break;

    case 'status':
      showStatus(repository);
      break;

    default:
      console.error(`âŒ ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: ${command}`);
      showHelp();
      process.exit(1);
  }
}

function showHelp() {
  console.log(`
ä½¿ç”¨æ–¹æ³•:
  npx miyabi run <issue-number>  - ç‰¹å®šã®Issueã‚’è‡ªå‹•å‡¦ç†
  npx miyabi list                - ã‚ªãƒ¼ãƒ—ãƒ³ãªIssueã‚’ä¸€è¦§è¡¨ç¤º
  npx miyabi status              - ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
  npx miyabi help                - ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

ä¾‹:
  npx miyabi run 3               - Issue #3 ã‚’å‡¦ç†
  npx miyabi list                - å…¨Issueã‚’è¡¨ç¤º
`);
}

async function runIssue(
  issueArg: string | undefined,
  github: GitHubClient,
  anthropicApiKey: string,
  repository: string
) {
  if (!issueArg) {
    console.error('âŒ Issueç•ªå·ã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
    console.error('   ä¾‹: npx miyabi run 3');
    process.exit(1);
  }

  const issueNumber = parseInt(issueArg, 10);
  if (isNaN(issueNumber)) {
    console.error(`âŒ ç„¡åŠ¹ãªIssueç•ªå·: ${issueArg}`);
    process.exit(1);
  }

  console.log(`\nğŸ“‹ Issue #${issueNumber} ã‚’å–å¾—ä¸­...`);

  try {
    const issue = await github.getIssue(issueNumber);
    console.log(`   ã‚¿ã‚¤ãƒˆãƒ«: ${issue.title}`);
    console.log(`   ãƒ©ãƒ™ãƒ«: ${issue.labels.join(', ') || '(ãªã—)'}`);

    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
    const context: AgentContext = {
      issue,
      repository,
      workDir: process.cwd(),
      githubToken: process.env.GITHUB_TOKEN!,
      anthropicApiKey,
    };

    // Coordinatorã‚’å®Ÿè¡Œ
    console.log('\nğŸš€ Miyabi Coordinator ã‚’èµ·å‹•...\n');
    const coordinator = new CoordinatorAgent(context);
    const result = await coordinator.execute();

    // çµæœã‚’è¡¨ç¤º
    console.log('\n' + '='.repeat(50));
    if (result.success) {
      console.log('âœ… å‡¦ç†å®Œäº†!');

      // GitHubã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
      await github.addComment(
        issueNumber,
        `ğŸŒ¸ **Miyabi Agent** ãŒå‡¦ç†ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚\n\n${result.message}\n\n---\n_Generated by Miyabi Framework_`
      );
      console.log('ğŸ“ GitHubã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    } else {
      console.log('âŒ å‡¦ç†å¤±æ•—');
      console.log(`   ã‚¨ãƒ©ãƒ¼: ${result.error || result.message}`);
    }

  } catch (error) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error instanceof Error ? error.message : error);
    process.exit(1);
  }
}

async function listIssues(github: GitHubClient) {
  console.log('ğŸ“‹ ã‚ªãƒ¼ãƒ—ãƒ³ãªIssueã‚’å–å¾—ä¸­...\n');

  try {
    const issues = await github.listOpenIssues();

    if (issues.length === 0) {
      console.log('   ã‚ªãƒ¼ãƒ—ãƒ³ãªIssueã¯ã‚ã‚Šã¾ã›ã‚“');
      return;
    }

    for (const issue of issues) {
      const labels = issue.labels.length > 0 ? ` [${issue.labels.join(', ')}]` : '';
      console.log(`  #${issue.number} ${issue.title}${labels}`);
    }

    console.log(`\nåˆè¨ˆ: ${issues.length}ä»¶`);
  } catch (error) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error instanceof Error ? error.message : error);
    process.exit(1);
  }
}

function showStatus(repository: string) {
  console.log(`ğŸ“Š Miyabi Status\n`);
  console.log(`   ãƒªãƒã‚¸ãƒˆãƒª: ${repository}`);
  console.log(`   ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ${process.cwd()}`);
  console.log(`   GitHub Token: ${process.env.GITHUB_TOKEN ? 'âœ“ è¨­å®šæ¸ˆã¿' : 'âœ— æœªè¨­å®š'}`);
  console.log(`   Anthropic API Key: ${process.env.ANTHROPIC_API_KEY ? 'âœ“ è¨­å®šæ¸ˆã¿' : 'âœ— æœªè¨­å®š'}`);
}

main().catch(error => {
  console.error('Fatal error:', error);
  process.exit(1);
});
